# üöÄ Briefing R√°pido: Projeto Meta-Tracking para IA ü§ñ

**√öltima Atualiza√ß√£o:** [2024-04-12] <!-- Atualize esta data ao modificar! -->

**Leia Isto Primeiro!** Este documento resume o essencial sobre o projeto Meta-Tracking. Consulte-o *antes* de qualquer an√°lise ou modifica√ß√£o para entender o contexto cr√≠tico e evitar erros passados. Use-o como fonte prim√°ria de verdade sobre o contexto do projeto.

---

## üéØ Objetivo Central do Projeto

- **O qu√™:** Receber eventos de rastreamento de sites clientes (via script JS simples), enriquec√™-los (GeoIP, normaliza√ß√£o) e envi√°-los para a API de Convers√µes do Meta (CAPI).
- **Por qu√™:** Melhorar a qualidade da correspond√™ncia de eventos no Meta Ads e permitir rastreamento server-side, superando limita√ß√µes de rastreamento no navegador.
- **Como:** Aplica√ß√£o Node.js/TypeScript (`meta-tracking`) hospedada no Render, servindo um script JS (`meta-pixel-script.js`) e processando eventos via API REST (`/track`).

---

## üèóÔ∏è Vis√£o Geral da Arquitetura

1.  **Frontend (Cliente):** **APENAS UMA LINHA!**
    ```html
    <script src="https://rastreamento-meta.onrender.com/meta-pixel-script.js"></script>
    ```
    *   **Ponto Chave:** Nenhuma l√≥gica adicional no cliente. Toda a intelig√™ncia de rastreamento no navegador est√° no script `meta-pixel-script.js` servido pelo backend.

2.  **Backend (Servidor - `meta-tracking`):**
    *   **Linguagem/Stack:** Node.js / TypeScript
    *   **Reposit√≥rio:** [https://github.com/marcioabreuba/Rastreamento_Meta.git](https://github.com/marcioabreuba/Rastreamento_Meta.git)
    *   **Hospedagem:** Render.com (deploy autom√°tico do branch `master`)
    *   **URL Base:** `https://rastreamento-meta.onrender.com/`
    *   **Responsabilidades:**
        *   Servir o script din√¢mico `meta-pixel-script.js`.
        *   Receber dados de eventos via endpoint API REST `/track`.
        *   Enriquecer dados: Geolocaliza√ß√£o via IP (`@maxmind/geoip2-node`), tratamento de IPv6/IPv4-mapped.
        *   Normalizar e Hashear dados PII (conforme regras do Meta - ver `eventUtils.ts` ou similar).
        *   Enviar eventos processados para a API de Convers√µes do Meta (CAPI).
    *   **Gerencia M√∫ltiplos Pixels:** O sistema √© projetado para lidar com diferentes IDs de Pixel Meta para diferentes clientes/dom√≠nios.

---

## ‚ö†Ô∏è Pontos Cr√≠ticos & Limita√ß√µes (Aten√ß√£o!)

*   **N√ÉO Modifique o Site Cliente:** Qualquer corre√ß√£o ou altera√ß√£o no comportamento do rastreamento do *navegador* deve ser feita no c√≥digo que gera o `meta-pixel-script.js` no *backend*, n√£o no site do cliente.
*   **Inicializa√ß√£o do Pixel no Browser √© ESSENCIAL:** O script `meta-pixel-script.js` *deve* chamar `fbq('init', PIXEL_ID)` e `fbq('track', 'PageView')`. O envio via CAPI complementa, mas n√£o substitui totalmente a necessidade do pixel no browser para deduplica√ß√£o e eventos base.
*   **Normaliza√ß√£o ANTES do Hashing:** Dados PII (ex: email, telefone, nome, geo) devem ser normalizados (lowercase, sem acentos/diacr√≠ticos, formato espec√≠fico) *antes* de aplicar o hash SHA-256.
*   **N√ÉO Hashear `fbp` e `fbc`:** Esses identificadores do Meta devem ser enviados como est√£o, sem hashing.
*   **Coleta de PII:** Este backend *processa* PII (ex: `fn`, `em`), mas a *coleta* desses dados depende da implementa√ß√£o no site cliente (formul√°rios, √°reas logadas, etc.). O backend n√£o coleta PII diretamente do usu√°rio.
*   **M√∫ltiplos Projetos/Pixels:** Tenha cuidado, pois pode haver outros sistemas ou pixels (ex: um segundo pixel mencionado no hist√≥rico) operando nos mesmos sites. Evite interfer√™ncias.
*   **Projeto de Refer√™ncia:** Existe um projeto PHP/Laravel na pasta `referencia/`. Ele possui alta performance e pode servir como benchmark ou fonte de inspira√ß√£o para boas pr√°ticas (ex: tratamento de erros, logging, otimiza√ß√µes).

---

## üìú Hist√≥rico de Problemas Relevantes (Resumo)

*   **[2023-11-14] - Baixa Qualidade de Correspond√™ncia no Meta (Score 6.7/10):**
    *   **Causas Raiz:**
        1.  Script `meta-pixel-script.js` n√£o chamava `fbq('init', ...)` nem `fbq('track', 'PageView')`.
        2.  Falta de normaliza√ß√£o adequada de dados geogr√°ficos antes do hashing.
        3.  Envio de `fn` (nome) vazio.
    *   **Solu√ß√£o:**
        1.  Corrigido `meta-pixel-script.js` para incluir chamadas `fbq` faltantes e evitar duplica√ß√£o.
        2.  Implementada normaliza√ß√£o aprimorada (sem acentos, etc.) em `eventUtils.ts` antes do hashing.
        3.  Garantido que `fbp`/`fbc` n√£o s√£o hasheados.
    *   **Li√ß√£o Principal:** A correta inicializa√ß√£o do pixel no browser e a normaliza√ß√£o *pr√©-hashing* dos dados PII s√£o absolutamente cruciais para a qualidade da correspond√™ncia e deduplica√ß√£o.

*   **[2024-04-11] - Eventos PageView N√£o Apareciam no Gerenciador de Eventos do Meta:**
    *   **Causas Raiz:**
        1.  A inicializa√ß√£o do pixel (`fbq('init', PIXEL_ID)`) estava sendo feita apenas durante o envio de eventos, n√£o no carregamento do script.
        2.  O PageView n√£o era enviado como primeiro evento, mas apenas ap√≥s um timeout para detectar o tipo de p√°gina.
        3.  A implementa√ß√£o manual do envio de pixel via imagem estava substituindo o fluxo padr√£o.
        4.  Os par√¢metros personalizados n√£o estavam sendo passados corretamente para o evento PageView.
    *   **Solu√ß√£o:**
        1.  Modificada fun√ß√£o `initFacebookPixel()` para inicializar o pixel imediatamente ap√≥s o carregamento.
        2.  Reestruturada fun√ß√£o `init()` para enviar `PageView` primeiro, antes de qualquer evento espec√≠fico.
        3.  Simplificada fun√ß√£o `sendEvent()` para usar a API JavaScript `fbq('track', ...)` padr√£o, mantendo os dados enriquecidos.
        4.  Adicionados par√¢metros personalizados (content_type, content_name) ao evento PageView inicial.
        5.  Implementada convers√£o de camelCase para snake_case nos par√¢metros de eventos para compatibilidade com o formato esperado pelo Meta.
    *   **Li√ß√£o Principal:** A sequ√™ncia de inicializa√ß√£o e envio de eventos √© cr√≠tica - o `PageView` deve ser sempre o primeiro evento, com par√¢metros de conte√∫do adequados, e a API JavaScript do Facebook (`fbq`) deve ser usada em vez de implementa√ß√µes manuais, para garantir compatibilidade com mecanismos de deduplica√ß√£o.

*   **[Adicionar outros problemas relevantes aqui resumidamente - Data, Problema, Causa Raiz, Solu√ß√£o, Li√ß√£o]**

---

## üõ†Ô∏è Como Trabalhar Neste Projeto (Guia para IA)

1.  **Entenda o Fluxo:** Cliente carrega HTML -> HTML carrega `meta-pixel-script.js` do nosso backend -> Script JS inicializa Pixel (`fbq('init',...)`, `fbq('track','PageView')`) -> A√ß√£o do usu√°rio dispara evento -> Script JS envia dados para `/track` (backend) -> Backend recebe em `/track`, enriquece com GeoIP, normaliza PII, hasheia PII -> Backend envia dados formatados para a Meta CAPI.
2.  **Localize o C√≥digo Relevante:**
    *   **L√≥gica do Browser:** C√≥digo TypeScript/JavaScript que gera/serve `meta-pixel-script.js`.
    *   **Processamento Backend:** Controller/Handler da rota `/track`, m√≥dulos/fun√ß√µes de utilit√°rios de eventos (como `eventUtils.ts`), servi√ßo de GeoIP, servi√ßo de envio para CAPI.
3.  **Verifique os "Pontos Cr√≠ticos" e o "Hist√≥rico":** Antes de propor solu√ß√µes, revise as se√ß√µes acima para garantir que sua sugest√£o n√£o viola uma regra estabelecida ou repete um erro passado.
4.  **Pe√ßa Contexto Adicional:** Se precisar ver o conte√∫do exato de arquivos como `eventUtils.ts`, a implementa√ß√£o da rota `/track`, ou a configura√ß√£o do GeoIP, solicite a leitura desses arquivos (`read_file`).
5.  **Considere a Refer√™ncia:** Se estiver buscando otimiza√ß√µes ou melhores pr√°ticas, pode ser √∫til pedir para analisar partes espec√≠ficas do projeto em `referencia/`.
6.  **Atualize Este Guia:** Se descobrirmos novas informa√ß√µes cr√≠ticas, resolvermos novos problemas significativos ou fizermos mudan√ßas arquiteturais, lembre-se de propor uma atualiza√ß√£o para este documento.

---

## üöÄ Pr√≥ximos Passos / Melhorias Pendentes

*   Implementar Banner de Consentimento LGPD/GDPR (tarefa pendente).
*   Melhorar o monitoramento e adicionar mais logs detalhados para diagn√≥stico de problemas de correspond√™ncia.
*   Implementar ferramentas de diagn√≥stico/debug (inspirado no projeto de refer√™ncia).
*   [Adicionar outros itens do backlog aqui]

---

## ‚úÖ Checklist para Manuten√ß√£o do Projeto

Para garantir a consist√™ncia e a integridade do projeto durante altera√ß√µes, **siga sempre este checklist**:

1. **Antes de modificar:**
   - Leia este guia para entender o contexto e poss√≠veis impactos
   - Valide sua proposta contra os pontos cr√≠ticos mencionados
   - Verifique o hist√≥rico para confirmar que n√£o est√° repetindo problemas resolvidos

2. **Ao implementar altera√ß√µes:**
   - Mantenha a compatibilidade com sites clientes existentes
   - Siga o padr√£o de c√≥digo e arquitetura estabelecido
   - Adicione logs adequados para facilitar depura√ß√£o
   - Teste a solu√ß√£o em ambiente de desenvolvimento antes de commitar

3. **Ap√≥s implementar:**
   - **OBRIGAT√ìRIO:** Atualize este Guia.MD com:
      - A data da atualiza√ß√£o
      - Detalhes sobre problemas significativos resolvidos
      - Novas funcionalidades ou mudan√ßas estruturais
   - Fa√ßa commit e push de todas as altera√ß√µes, **incluindo o Guia.MD**
   - Verifique se o deploy foi conclu√≠do com sucesso
   - Monitore o comportamento ap√≥s a implementa√ß√£o 

---
*Este documento √© a fonte da verdade contextual para o projeto Meta-Tracking.*