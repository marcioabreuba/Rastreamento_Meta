# ğŸš€ Briefing RÃ¡pido: Projeto Meta-Tracking para IA ğŸ¤–

**Ãšltima AtualizaÃ§Ã£o:** [2024-04-12] <!-- Atualize esta data ao modificar! -->

**Leia Isto Primeiro!** Este documento resume o essencial sobre o projeto Meta-Tracking. Consulte-o *antes* de qualquer anÃ¡lise ou modificaÃ§Ã£o para entender o contexto crÃ­tico e evitar erros passados. Use-o como fonte primÃ¡ria de verdade sobre o contexto do projeto.

---

## ğŸ¯ Objetivo Central do Projeto

- **O quÃª:** Receber eventos de rastreamento de sites clientes (via script JS simples), enriquecÃª-los (GeoIP, normalizaÃ§Ã£o) e enviÃ¡-los para a API de ConversÃµes do Meta (CAPI).
- **Por quÃª:** Melhorar a qualidade da correspondÃªncia de eventos no Meta Ads e permitir rastreamento server-side, superando limitaÃ§Ãµes de rastreamento no navegador.
- **Como:** AplicaÃ§Ã£o Node.js/TypeScript (`meta-tracking`) hospedada no Render, servindo um script JS (`meta-pixel-script.js`) e processando eventos via API REST (`/track`).

---

## ğŸ—ï¸ VisÃ£o Geral da Arquitetura

1.  **Frontend (Cliente):** **APENAS UMA LINHA!**
    ```html
    <script src="https://rastreamento-meta.onrender.com/meta-pixel-script.js"></script>
    ```
    *   **Ponto Chave:** Nenhuma lÃ³gica adicional no cliente. Toda a inteligÃªncia de rastreamento no navegador estÃ¡ no script `meta-pixel-script.js` servido pelo backend.

2.  **Backend (Servidor - `meta-tracking`):**
    *   **Linguagem/Stack:** Node.js / TypeScript
    *   **RepositÃ³rio:** [https://github.com/marcioabreuba/Rastreamento_Meta.git](https://github.com/marcioabreuba/Rastreamento_Meta.git)
    *   **Hospedagem:** Render.com (deploy automÃ¡tico do branch `master`)
    *   **URL Base:** `https://rastreamento-meta.onrender.com/`
    *   **Responsabilidades:**
        *   Servir o script dinÃ¢mico `meta-pixel-script.js`.
        *   Receber dados de eventos via endpoint API REST `/track`.
        *   Enriquecer dados: GeolocalizaÃ§Ã£o via IP (`@maxmind/geoip2-node`), tratamento de IPv6/IPv4-mapped.
        *   Normalizar e Hashear dados PII (conforme regras do Meta - ver `eventUtils.ts` ou similar).
        *   Enviar eventos processados para a API de ConversÃµes do Meta (CAPI).
    *   **Gerencia MÃºltiplos Pixels:** O sistema Ã© projetado para lidar com diferentes IDs de Pixel Meta para diferentes clientes/domÃ­nios.

---

## âš ï¸ Pontos CrÃ­ticos & LimitaÃ§Ãµes (AtenÃ§Ã£o!)

*   **NÃƒO Modifique o Site Cliente:** Qualquer correÃ§Ã£o ou alteraÃ§Ã£o no comportamento do rastreamento do *navegador* deve ser feita no cÃ³digo que gera o `meta-pixel-script.js` no *backend*, nÃ£o no site do cliente.
*   **InicializaÃ§Ã£o do Pixel no Browser Ã© ESSENCIAL:** O script `meta-pixel-script.js` *deve* chamar `fbq('init', PIXEL_ID)` e `fbq('track', 'PageView')`. O envio via CAPI complementa, mas nÃ£o substitui totalmente a necessidade do pixel no browser para deduplicaÃ§Ã£o e eventos base.
*   **NormalizaÃ§Ã£o ANTES do Hashing:** Dados PII (ex: email, telefone, nome, geo) devem ser normalizados (lowercase, sem acentos/diacrÃ­ticos, formato especÃ­fico) *antes* de aplicar o hash SHA-256.
*   **NÃƒO Hashear `fbp` e `fbc`:** Esses identificadores do Meta devem ser enviados como estÃ£o, sem hashing.
*   **Coleta de PII:** Este backend *processa* PII (ex: `fn`, `em`), mas a *coleta* desses dados depende da implementaÃ§Ã£o no site cliente (formulÃ¡rios, Ã¡reas logadas, etc.). O backend nÃ£o coleta PII diretamente do usuÃ¡rio.
*   **MÃºltiplos Projetos/Pixels:** Tenha cuidado, pois pode haver outros sistemas ou pixels (ex: um segundo pixel mencionado no histÃ³rico) operando nos mesmos sites. Evite interferÃªncias.
*   **Projeto de ReferÃªncia:** Existe um projeto PHP/Laravel na pasta `referencia/`. Ele possui alta performance e pode servir como benchmark ou fonte de inspiraÃ§Ã£o para boas prÃ¡ticas (ex: tratamento de erros, logging, otimizaÃ§Ãµes).

---

## ğŸ“œ HistÃ³rico de Problemas Relevantes (Resumo)

*   **[2023-11-14] - Baixa Qualidade de CorrespondÃªncia no Meta (Score 6.7/10):**
    *   **Causas Raiz:**
        1.  Script `meta-pixel-script.js` nÃ£o chamava `fbq('init', ...)` nem `fbq('track', 'PageView')`.
        2.  Falta de normalizaÃ§Ã£o adequada de dados geogrÃ¡ficos antes do hashing.
        3.  Envio de `fn` (nome) vazio.
    *   **SoluÃ§Ã£o:**
        1.  Corrigido `meta-pixel-script.js` para incluir chamadas `fbq` faltantes e evitar duplicaÃ§Ã£o.
        2.  Implementada normalizaÃ§Ã£o aprimorada (sem acentos, etc.) em `eventUtils.ts` antes do hashing.
        3.  Garantido que `fbp`/`fbc` nÃ£o sÃ£o hasheados.
    *   **LiÃ§Ã£o Principal:** A correta inicializaÃ§Ã£o do pixel no browser e a normalizaÃ§Ã£o *prÃ©-hashing* dos dados PII sÃ£o absolutamente cruciais para a qualidade da correspondÃªncia e deduplicaÃ§Ã£o.

*   **[2024-04-11] - Eventos PageView NÃ£o Apareciam no Gerenciador de Eventos do Meta:**
    *   **Causas Raiz:**
        1.  A inicializaÃ§Ã£o do pixel (`fbq('init', PIXEL_ID)`) estava sendo feita apenas durante o envio de eventos, nÃ£o no carregamento do script.
        2.  O PageView nÃ£o era enviado como primeiro evento, mas apenas apÃ³s um timeout para detectar o tipo de pÃ¡gina.
        3.  A implementaÃ§Ã£o manual do envio de pixel via imagem estava substituindo o fluxo padrÃ£o.
    *   **SoluÃ§Ã£o:**
        1.  Modificada funÃ§Ã£o `initFacebookPixel()` para inicializar o pixel imediatamente apÃ³s o carregamento.
        2.  Reestruturada funÃ§Ã£o `init()` para enviar `PageView` primeiro, antes de qualquer evento especÃ­fico.
        3.  Simplificada funÃ§Ã£o `sendEvent()` para usar a API JavaScript `fbq('track', ...)` padrÃ£o, mantendo os dados enriquecidos.
    *   **LiÃ§Ã£o Principal:** A sequÃªncia de inicializaÃ§Ã£o e envio de eventos Ã© crÃ­tica - o `PageView` deve ser sempre o primeiro evento e a API JavaScript do Facebook (`fbq`) deve ser usada em vez de implementaÃ§Ãµes manuais, para garantir compatibilidade com mecanismos de deduplicaÃ§Ã£o.

*   **[Adicionar outros problemas relevantes aqui resumidamente - Data, Problema, Causa Raiz, SoluÃ§Ã£o, LiÃ§Ã£o]**

---

## ğŸ› ï¸ Como Trabalhar Neste Projeto (Guia para IA)

1.  **Entenda o Fluxo:** Cliente carrega HTML -> HTML carrega `meta-pixel-script.js` do nosso backend -> Script JS inicializa Pixel (`fbq('init',...)`, `fbq('track','PageView')`) -> AÃ§Ã£o do usuÃ¡rio dispara evento -> Script JS envia dados para `/track` (backend) -> Backend recebe em `/track`, enriquece com GeoIP, normaliza PII, hasheia PII -> Backend envia dados formatados para a Meta CAPI.
2.  **Localize o CÃ³digo Relevante:**
    *   **LÃ³gica do Browser:** CÃ³digo TypeScript/JavaScript que gera/serve `meta-pixel-script.js`.
    *   **Processamento Backend:** Controller/Handler da rota `/track`, mÃ³dulos/funÃ§Ãµes de utilitÃ¡rios de eventos (como `eventUtils.ts`), serviÃ§o de GeoIP, serviÃ§o de envio para CAPI.
3.  **Verifique os "Pontos CrÃ­ticos" e o "HistÃ³rico":** Antes de propor soluÃ§Ãµes, revise as seÃ§Ãµes acima para garantir que sua sugestÃ£o nÃ£o viola uma regra estabelecida ou repete um erro passado.
4.  **PeÃ§a Contexto Adicional:** Se precisar ver o conteÃºdo exato de arquivos como `eventUtils.ts`, a implementaÃ§Ã£o da rota `/track`, ou a configuraÃ§Ã£o do GeoIP, solicite a leitura desses arquivos (`read_file`).
5.  **Considere a ReferÃªncia:** Se estiver buscando otimizaÃ§Ãµes ou melhores prÃ¡ticas, pode ser Ãºtil pedir para analisar partes especÃ­ficas do projeto em `referencia/`.
6.  **Atualize Este Guia:** Se descobrirmos novas informaÃ§Ãµes crÃ­ticas, resolvermos novos problemas significativos ou fizermos mudanÃ§as arquiteturais, lembre-se de propor uma atualizaÃ§Ã£o para este documento.

---

## ğŸš€ PrÃ³ximos Passos / Melhorias Pendentes

*   Implementar Banner de Consentimento LGPD/GDPR (tarefa pendente).
*   Melhorar o monitoramento e adicionar mais logs detalhados para diagnÃ³stico de problemas de correspondÃªncia.
*   Implementar ferramentas de diagnÃ³stico/debug (inspirado no projeto de referÃªncia).
*   [Adicionar outros itens do backlog aqui]

---
*Este documento Ã© a fonte da verdade contextual para o projeto Meta-Tracking.*